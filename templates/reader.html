{% extends "base.html" %}

{% block title %}Leitor - {{ epub_data.title }}{% endblock %}

{% block content %}
<div class="mui-container">
    <!-- Header -->
    <div class="mui-reader-header">
        <div class="mui-reader-header__content">
            <h1 class="mui-reader-header__title">
                <span class="mui-icon mui-icon--book"></span>
                {{ epub_data.title or 'EPUB Sem Título' }}
                {% if epub_data.chapters and epub_data.chapters[0].translated_content %}
                <span class="mui-translation-badge">
                    <span class="mui-icon mui-icon--translate"></span>
                    Traduzido
                </span>
                {% endif %}
            </h1>
            <div class="mui-reader-header__actions">
                <button id="translateAllBtn" class="mui-button mui-button--contained mui-button--primary">
                    <span class="mui-icon mui-icon--translate"></span>
                    Traduzir Tudo
                </button>
                <a href="{{ url_for('_func_DownloadEpub', file_id=file_id) }}" class="mui-button mui-button--contained mui-button--primary">
                    <span class="mui-icon mui-icon--download"></span>
                    Download EPUB
                </a>
                <a href="{{ url_for('index') }}" class="mui-button mui-button--outlined">
                    <span class="mui-icon mui-icon--home"></span>
                    Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="mui-reader-controls">
        <div class="mui-reader-controls__content">
            <div class="mui-reader-controls__left">
                <button id="prevChapter" class="mui-button mui-button--outlined" disabled>
                    <span class="mui-icon mui-icon--navigate_before"></span>
                    Anterior
                </button>
                <span class="mui-reader-controls__info">
                    Capítulo <span id="currentChapter">1</span> de <span id="totalChapters">{{ epub_data.chapters|length }}</span>
                </span>
                <button id="nextChapter" class="mui-button mui-button--outlined">
                    <span class="mui-icon mui-icon--navigate_next"></span>
                    Próximo
                </button>
            </div>
            <div class="mui-reader-controls__right">
                <button id="translateBtn" class="mui-button mui-button--outlined">
                    <span class="mui-icon mui-icon--translate"></span>
                    Traduzir Capítulo
                </button>
                <button id="toggleOriginalBtn" class="mui-button mui-button--outlined" style="display:none;">
                    <span class="mui-icon mui-icon--visibility"></span>
                    Ver original
                </button>
            </div>
        </div>
    </div>

    <!-- Reader Content -->
    <div class="mui-reader-content">
        <div class="mui-reader-panel">
            <!-- Chapter Navigation -->
            <div class="mui-reader-sidebar">
                <div class="mui-reader-sidebar__header">
                    <h3 class="mui-reader-sidebar__title">
                        <span class="mui-icon mui-icon--list"></span>
                        Capítulos
                    </h3>
                </div>
                <div class="mui-reader-sidebar__content">
                    <div class="mui-chapter-list" id="chapterList">
                        {% for chapter in epub_data.chapters %}
                        <button class="mui-chapter-item" data-chapter="{{ loop.index0 }}">
                            <span class="mui-chapter-item__number">{{ loop.index }}</span>
                            <span class="mui-chapter-item__title">{{ chapter.title }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="mui-reader-main">
                <div class="mui-reader-text" id="readerText">
                    {% if epub_data.chapters %}
                    <div class="mui-chapter-content" data-chapter="0">
                        <h2 class="mui-chapter-title">{{ epub_data.chapters[0].title }}</h2>
                        <div class="mui-chapter-text">
                            {{ epub_data.chapters[0].content|replace('\n', '<br>')|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="mui-empty-state">
                        <span class="mui-icon mui-icon--book"></span>
                        <h3>Nenhum conteúdo encontrado</h3>
                        <p>Este EPUB não contém capítulos para exibir.</p>
                    </div>
                    {% endif %}
                </div>
                <!-- Loading overlay -->
                <div class="mui-loading-overlay" id="loadingOverlay">
                    <div class="mui-loading-content">
                        <div class="mui-loading-spinner"></div>
                        <p class="mui-loading-text">Traduzindo capítulo...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation Progress Modal -->
    <div class="mui-modal" id="progressModal">
        <div class="mui-modal__overlay" id="progressModalOverlay"></div>
        <div class="mui-modal__content">
            <div class="mui-modal__header">
                <h2 class="mui-modal__title">
                    <span class="mui-icon mui-icon--translate"></span>
                    Traduzindo EPUB
                </h2>
            </div>
            <div class="mui-modal__body">
                <div class="mui-progress-container">
                    <div class="mui-progress-info">
                        <p class="mui-progress-text" id="progressText">Iniciando tradução...</p>
                        <p class="mui-progress-details" id="progressDetails">Capítulo 1 de {{ epub_data.chapters|length }}</p>
                    </div>
                    <div class="mui-progress-bar">
                        <div class="mui-progress-fill" id="progressFill"></div>
                    </div>
                    <div class="mui-progress-percentage" id="progressPercentage">0%</div>
                </div>
            </div>
            <div class="mui-modal__footer" id="progressFooter">
                <button class="mui-button mui-button--outlined" id="cancelProgress" style="display:none;">
                    Cancelar
                </button>
                <button class="mui-button mui-button--contained mui-button--primary" id="downloadTranslatedBtn" style="display:none;">
                    <span class="mui-icon mui-icon--download"></span>
                    Download EPUB Traduzido
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Dictionary Bar -->
    <div class="mui-quick-dict-bar" id="quickDictBar" style="display:none;">
        <form id="quickDictForm" class="mui-quick-dict-form">
            <div class="mui-quick-dict-inputs">
                <input type="text" id="quickDictOriginal" class="mui-input" placeholder="Texto original" readonly>
                <input type="text" id="quickDictTranslation" class="mui-input" placeholder="Tradução personalizada">
            </div>
            <div class="mui-quick-dict-actions">
                <button type="submit" class="mui-button mui-button--contained mui-button--primary">
                    <span class="mui-icon mui-icon--add"></span>
                    Adicionar
                </button>
                <button type="button" class="mui-button mui-button--outlined" id="quickDictCancel">
                    <span class="mui-icon mui-icon--close"></span>
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/reader.js') }}"></script>
<script>
    // Inicializar dados dos capítulos
    document.addEventListener('DOMContentLoaded', function() {
        const dadosCapitulos = {{ epub_data.chapters|tojson|safe }};
        const fileId = '{{ file_id }}';
        _func_InicializarDadosCapitulos(dadosCapitulos, fileId);
    });
</script>
{% endblock %} 