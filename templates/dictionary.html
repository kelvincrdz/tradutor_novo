{% extends "base.html" %}

{% block title %}Dicionário - EPUB Translator{% endblock %}

{% block content %}
<div class="mui-container">
    <!-- Header -->
    <div class="mui-dictionary-header">
        <div class="mui-dictionary-header__content">
            <h1 class="mui-dictionary-header__title">
                <span class="mui-icon mui-icon--translate"></span>
                Dicionário Personalizado
            </h1>
            <p class="mui-dictionary-header__description">
                Gerencie suas traduções personalizadas para melhorar a qualidade das traduções automáticas
            </p>
        </div>
    </div>

    <!-- Add New Entry -->
    <div class="mui-section">
        <div class="mui-card">
            <div class="mui-card__header">
                <h2 class="mui-card__title">
                    <span class="mui-icon mui-icon--add"></span>
                    Adicionar Nova Entrada
                </h2>
                <p class="mui-card__subtitle">
                    Adicione palavras ou frases com suas traduções personalizadas
                </p>
            </div>
            <div class="mui-card__content">
                <form id="addEntryForm" class="mui-form">
                    <div class="mui-form-row">
                        <div class="mui-form-group">
                            <label class="mui-form-label" for="originalText">Texto Original:</label>
                            <input type="text" id="originalText" name="original" class="mui-input" required placeholder="Digite o texto original...">
                        </div>
                        <div class="mui-form-group">
                            <label class="mui-form-label" for="translatedText">Tradução:</label>
                            <input type="text" id="translatedText" name="translated" class="mui-input" required placeholder="Digite a tradução...">
                        </div>
                    </div>
                    <div class="mui-form-actions">
                        <button type="submit" class="mui-button mui-button--contained mui-button--primary">
                            <span class="mui-icon mui-icon--add"></span>
                            Adicionar ao Dicionário
                        </button>
                    </div>
                </form>
            </div>
        </div>
        </div>

    <!-- Dictionary List -->
    <div class="mui-section">
        <div class="mui-card">
            <div class="mui-card__header">
                <h2 class="mui-card__title">
                    <span class="mui-icon mui-icon--list"></span>
                    Entradas do Dicionário
                </h2>
                <p class="mui-card__subtitle">
                    {{ dictionary|length }} entradas cadastradas
                </p>
            </div>
            <div class="mui-card__content">
                {% if dictionary %}
                <div class="mui-dictionary-list">
                    {% for original, translated in dictionary.items() %}
                    <div class="mui-dictionary-item" data-original="{{ original }}">
                        <div class="mui-dictionary-item__content">
                            <div class="mui-dictionary-item__text">
                                <div class="mui-dictionary-item__original">
                                    <strong>Original:</strong> {{ original }}
                                </div>
                                <div class="mui-dictionary-item__translated">
                                    <strong>Tradução:</strong> {{ translated }}
                                </div>
                            </div>
                            <div class="mui-dictionary-item__actions">
                                <button class="mui-button mui-button--outlined mui-button--small" onclick="editEntry('{{ original }}', '{{ translated }}')">
                                    <span class="mui-icon mui-icon--edit"></span>
                                    Editar
                                </button>
                                <button class="mui-button mui-button--outlined mui-button--small mui-button--danger" onclick="removeEntry('{{ original }}')">
                                    <span class="mui-icon mui-icon--delete"></span>
                                    Remover
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="mui-empty-state">
                    <span class="mui-icon mui-icon--translate"></span>
                    <h3>Nenhuma entrada encontrada</h3>
                    <p>Adicione sua primeira entrada ao dicionário para começar.</p>
                </div>
                {% endif %}
            </div>
        </div>
                    </div>
                    
    <!-- Search -->
    <div class="mui-section">
        <div class="mui-card">
            <div class="mui-card__header">
                <h2 class="mui-card__title">
                    <span class="mui-icon mui-icon--search"></span>
                    Buscar no Dicionário
                </h2>
            </div>
            <div class="mui-card__content">
                <div class="mui-search">
                    <div class="mui-search__input">
                        <span class="mui-icon mui-icon--search"></span>
                        <input type="text" id="searchInput" class="mui-input" placeholder="Buscar por texto original ou tradução...">
                    </div>
                </div>
                <div id="searchResults" class="mui-search-results"></div>
            </div>
        </div>
    </div>

    <!-- Import/Export Dictionary -->
    <div class="mui-section">
        <div class="mui-card">
            <div class="mui-card__header">
                <h2 class="mui-card__title">
                    <span class="mui-icon mui-icon--settings"></span>
                    Importar/Exportar Dicionário
                </h2>
                <p class="mui-card__subtitle">
                    Faça backup do seu dicionário ou importe entradas de outros arquivos
                </p>
            </div>
            <div class="mui-card__content">
                <div class="mui-form-row">
                    <div class="mui-form-group">
                        <label class="mui-form-label">Upload de Dicionário:</label>
                        <form id="uploadForm" enctype="multipart/form-data" class="mui-upload-form">
                            <div class="mui-upload-area" id="dictionaryUploadArea">
                                <span class="mui-icon mui-icon--upload"></span>
                                <p class="mui-upload-text">
                                    <strong>Clique para selecionar</strong> ou arraste o arquivo JSON aqui
                                </p>
                                <p class="mui-upload-hint">Formatos suportados: .json</p>
                                <input type="file" id="dictionaryFile" name="dictionary_file" accept=".json" class="mui-file-input" required>
                            </div>
                            <div class="mui-form-actions">
                                <button type="submit" class="mui-button mui-button--contained mui-button--primary">
                                    <span class="mui-icon mui-icon--upload"></span>
                                    Importar Dicionário
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="mui-form-group">
                        <label class="mui-form-label">Download do Dicionário:</label>
                        <div class="mui-download-area">
                            <span class="mui-icon mui-icon--download"></span>
                            <p class="mui-upload-text">
                                <strong>Baixe seu dicionário</strong> em formato JSON
                            </p>
                            <p class="mui-upload-hint">Backup completo das suas traduções personalizadas</p>
                            <a href="/dictionary/download" class="mui-button mui-button--outlined">
                                <span class="mui-icon mui-icon--download"></span>
                                Exportar Dicionário
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                
<!-- Edit Modal -->
<div class="mui-modal" id="editModal">
    <div class="mui-modal__overlay" id="editModalOverlay"></div>
    <div class="mui-modal__content">
        <div class="mui-modal__header">
            <h2 class="mui-modal__title">
                <span class="mui-icon mui-icon--edit"></span>
                Editar Entrada
            </h2>
            <button class="mui-modal__close" id="closeEditModal">
                <span class="mui-icon mui-icon--close"></span>
                    </button>
        </div>
        <div class="mui-modal__body">
            <form id="editEntryForm" class="mui-form">
                <div class="mui-form-group">
                    <label class="mui-form-label" for="editOriginalText">Texto Original:</label>
                    <input type="text" id="editOriginalText" name="original" class="mui-input" required>
                </div>
                <div class="mui-form-group">
                    <label class="mui-form-label" for="editTranslatedText">Tradução:</label>
                    <input type="text" id="editTranslatedText" name="translated" class="mui-input" required>
                </div>
            </form>
        </div>
        <div class="mui-modal__footer">
            <button class="mui-button mui-button--outlined" id="cancelEdit">
                Cancelar
            </button>
            <button class="mui-button mui-button--contained mui-button--primary" id="saveEdit">
                <span class="mui-icon mui-icon--save"></span>
                Salvar Alterações
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    setupSearch();
    setupDictionaryUpload();
});
    
function setupEventListeners() {
    // Add entry form
    document.getElementById('addEntryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addEntry();
    });

    // Upload dictionary form
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadDictionary();
    });

    // Edit modal
    document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
    document.getElementById('editModalOverlay').addEventListener('click', closeEditModal);
    document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
    document.getElementById('saveEdit').addEventListener('click', saveEdit);
}

function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const items = document.querySelectorAll('.mui-dictionary-item');
        
        if (query === '') {
            items.forEach(item => item.style.display = 'block');
            searchResults.innerHTML = '';
            return;
        }
        
        let foundItems = [];
        items.forEach(item => {
            const original = item.querySelector('.mui-dictionary-item__original').textContent.toLowerCase();
            const translated = item.querySelector('.mui-dictionary-item__translated').textContent.toLowerCase();
            
            if (original.includes(query) || translated.includes(query)) {
                foundItems.push(item);
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        if (foundItems.length === 0) {
            searchResults.innerHTML = `
                <div class="mui-empty-state">
                    <span class="mui-icon mui-icon--search"></span>
                    <h3>Nenhum resultado encontrado</h3>
                    <p>Tente usar termos diferentes na busca.</p>
                </div>
            `;
        } else {
            searchResults.innerHTML = '';
        }
    });
}

function setupDictionaryUpload() {
    const uploadArea = document.getElementById('dictionaryUploadArea');
    const fileInput = document.getElementById('dictionaryFile');
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('mui-upload-area--dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('mui-upload-area--dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('mui-upload-area--dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
        }
    });
    
    // Click to select file
    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // File input change
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const fileName = this.files[0].name;
            const uploadText = uploadArea.querySelector('.mui-upload-text');
            uploadText.innerHTML = `<strong>Arquivo selecionado:</strong> ${fileName}`;
        }
    });
}

function addEntry() {
    const original = document.getElementById('originalText').value.trim();
    const translated = document.getElementById('translatedText').value.trim();
    
    if (!original || !translated) {
        showNotification('Por favor, preencha todos os campos.', 'error');
        return;
    }
    
    fetch('/dictionary/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            original: original,
            translated: translated
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Entrada adicionada com sucesso!', 'success');
            document.getElementById('addEntryForm').reset();
            // Reload page to show new entry
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erro ao adicionar entrada: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao adicionar entrada: ' + error.message, 'error');
    });
}

function uploadDictionary() {
    const fileInput = document.getElementById('dictionaryFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('Por favor, selecione um arquivo.', 'error');
        return;
    }
    
    if (!file.name.endsWith('.json')) {
        showNotification('Por favor, selecione apenas arquivos JSON.', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('dictionary_file', file);
    
    fetch('/dictionary/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            fileInput.value = '';
            // Reload page to show new entries
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erro ao importar dicionário: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao importar dicionário: ' + error.message, 'error');
    });
}

function editEntry(original, translated) {
    document.getElementById('editOriginalText').value = original;
    document.getElementById('editTranslatedText').value = translated;
    document.getElementById('editModal').classList.add('mui-modal--open');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('mui-modal--open');
    }

function saveEdit() {
    const original = document.getElementById('editOriginalText').value.trim();
    const translated = document.getElementById('editTranslatedText').value.trim();
    
    if (!original || !translated) {
        showNotification('Por favor, preencha todos os campos.', 'error');
        return;
    }
    
    // For simplicity, we'll remove the old entry and add the new one
    // In a real application, you might want a dedicated edit endpoint
    fetch('/dictionary/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            original: original
        })
    })
    .then(() => {
        return fetch('/dictionary/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                original: original,
                translated: translated
            })
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Entrada atualizada com sucesso!', 'success');
            closeEditModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erro ao atualizar entrada: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao atualizar entrada: ' + error.message, 'error');
    });
}

function removeEntry(original) {
    if (!confirm('Tem certeza que deseja remover esta entrada?')) {
        return;
    }
    
    fetch('/dictionary/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                original: original
            })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Entrada removida com sucesso!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erro ao remover entrada: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao remover entrada: ' + error.message, 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `mui-notification mui-notification--${type}`;
    notification.innerHTML = `
        <span class="mui-icon mui-icon--${type === 'success' ? 'check' : 'error'}"></span>
        <span class="mui-notification__message">${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('mui-notification--show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('mui-notification--show');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %} 